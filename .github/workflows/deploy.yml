name: Deploy to IONOS VPS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [closed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ— Checkout code
      uses: actions/checkout@v4

    - name: ğŸ— Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ— Build application
      run: |
        npm run build
        ls -la apps/web/.next || echo "Build directory not found"
        ls -la apps/web/public || echo "Public directory not found"
      env:
        NODE_ENV: production
        NEXT_PUBLIC_SITE_URL: ${{ secrets.SITE_URL }}

    - name: ğŸ§ª Run tests (optional)
      run: npm run test --if-present

    - name: ğŸ“‚ Create deployment package
      run: |
        # Create a combined package.json for production
        echo "Creating production package.json..."
        cat > production-package.json << 'EOF'
        {
          "name": "portfolio-production",
          "version": "0.1.0",
          "private": true,
          "scripts": {
            "start": "node app.js",
            "build": "echo 'Build already completed'"
          },
          "dependencies": {
            "next": "^15.0.0",
            "react": "^18.3.1",
            "react-dom": "^18.3.1",
            "@mdx-js/loader": "^3.0.0",
            "@mdx-js/react": "^3.0.0",
            "@next/mdx": "^15.0.0",
            "@tailwindcss/typography": "^0.5.10",
            "gray-matter": "^4.0.3",
            "lucide-react": "^0.447.0",
            "next-mdx-remote": "^5.0.0",
            "next-themes": "^0.2.1",
            "pdfjs-dist": "^5.3.93"
          },
          "engines": {
            "node": ">=18.0.0",
            "npm": ">=8.0.0"
          }
        }
        EOF
        
        # Create temporary directory for deployment files
        mkdir -p temp-deploy
        
        # Copy files with proper structure
        cp -r apps/web/.next temp-deploy/ 2>/dev/null || echo "Warning: .next not found"
        cp -r apps/web/public temp-deploy/ 2>/dev/null || echo "Warning: public not found"
        cp apps/web/package.json temp-deploy/web-package.json 2>/dev/null || echo "Warning: web package.json not found"
        cp apps/web/next.config.js temp-deploy/ 2>/dev/null || echo "Warning: next.config.js not found"
        cp app.js temp-deploy/
        cp ecosystem.config.js temp-deploy/ 2>/dev/null || echo "Warning: ecosystem.config.js not found"
        cp production-package.json temp-deploy/package.json
        
        # Create archive from temp directory
        cd temp-deploy
        tar --exclude='node_modules' --exclude='.git' --exclude='.env.local' -czf ../deployment.tar.gz *
        cd ..
        
        # Clean up
        rm -rf temp-deploy production-package.json
        
        # Verify archive contents
        echo "Deployment package contents:"
        tar -tzf deployment.tar.gz | head -20

    - name: ğŸš€ Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || '22' }}
        script: |
          echo "=== Starting deployment ==="
          
          # Basic environment check
          echo "Current user: $(whoami)"
          echo "Current directory: $(pwd)"
          echo "Home directory: $HOME"
          
          # Check if we can access the target path
          echo "=== Testing directory access ==="
          if [ -d "/var/www" ]; then
            echo "âœ… /var/www exists"
            ls -la /var/www/ || echo "Cannot list /var/www/"
          else
            echo "âŒ /var/www does not exist"
          fi
          
          if [ -d "/var/www/vhosts" ]; then
            echo "âœ… /var/www/vhosts exists" 
            ls -la /var/www/vhosts/ || echo "Cannot list /var/www/vhosts/"
          else
            echo "âŒ /var/www/vhosts does not exist"
          fi
          
          # Check for domain directory
          DOMAIN_DIR="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}"
          echo "Checking domain directory: $DOMAIN_DIR"
          if [ -d "$DOMAIN_DIR" ]; then
            echo "âœ… Domain directory exists"
            ls -la "$DOMAIN_DIR/" || echo "Cannot list domain directory"
          else
            echo "âŒ Domain directory does not exist"
          fi
          
          # Check for httpdocs
          HTTPDOCS_DIR="$DOMAIN_DIR/httpdocs"
          echo "Checking httpdocs: $HTTPDOCS_DIR"
          if [ -d "$HTTPDOCS_DIR" ]; then
            echo "âœ… httpdocs directory exists"
            ls -la "$HTTPDOCS_DIR/" || echo "Cannot list httpdocs"
          else
            echo "âŒ httpdocs directory does not exist"
            echo "Attempting to create httpdocs directory..."
            mkdir -p "$HTTPDOCS_DIR" && echo "âœ… Created httpdocs" || echo "âŒ Failed to create httpdocs"
          fi
          
          # Try to navigate to working directory
          if [ -d "$HTTPDOCS_DIR" ]; then
            cd "$HTTPDOCS_DIR" && echo "âœ… Successfully navigated to httpdocs" || echo "âŒ Failed to navigate to httpdocs"
            echo "Working directory: $(pwd)"
          else
            echo "Using current directory as working directory: $(pwd)"
          fi
          
          echo "=== Pre-deployment setup completed ==="

    - name: ğŸ“¤ Upload files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || '22' }}
        source: "deployment.tar.gz"
        target: "~/deployment.tar.gz"
        strip_components: 0
      continue-on-error: false

    - name: ğŸ”§ Configure and start application
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || '22' }}
        script: |
          echo "=== Starting application configuration ==="
          
          # Find the deployment file
          if [ -f "~/deployment.tar.gz" ]; then
            DEPLOY_FILE="~/deployment.tar.gz"
          elif [ -f "deployment.tar.gz" ]; then
            DEPLOY_FILE="deployment.tar.gz"
          else
            echo "âŒ Deployment file not found"
            ls -la ~
            exit 1
          fi
          
          echo "Found deployment file: $DEPLOY_FILE"
          
          # Determine working directory
          WORK_DIR="/var/www/vhosts/${{ secrets.DOMAIN_NAME }}/httpdocs"
          if [ -d "$WORK_DIR" ]; then
            echo "Using Plesk directory: $WORK_DIR"
            cd "$WORK_DIR" || {
              echo "Failed to access Plesk directory, using home directory"
              WORK_DIR="$HOME/portfolio"
              mkdir -p "$WORK_DIR"
              cd "$WORK_DIR"
            }
          else
            echo "Plesk directory not accessible, using home directory"
            WORK_DIR="$HOME/portfolio"
            mkdir -p "$WORK_DIR"
            cd "$WORK_DIR"
          fi
          
          echo "Working directory: $(pwd)"
          
          # Copy and extract deployment
          cp "$DEPLOY_FILE" . || {
            echo "âŒ Failed to copy deployment file"
            exit 1
          }
          
          tar -xzf deployment.tar.gz || {
            echo "âŒ Failed to extract deployment"
            ls -la
            exit 1
          }
          rm deployment.tar.gz
          
          echo "âœ… Files extracted successfully"
          ls -la | head -10

          # Create directory structure
          mkdir -p logs apps/web

          # Move files to correct locations for monorepo structure
          if [ -d ".next" ]; then
            mv .next apps/web/
          fi
          if [ -d "public" ]; then
            mv public apps/web/
          fi
          if [ -f "web-package.json" ]; then
            mv web-package.json apps/web/package.json
          fi
          if [ -f "next.config.js" ]; then
            mv next.config.js apps/web/
          fi

          # Install Node.js if not present
          if ! command -v node &> /dev/null; then
            echo "âŒ Node.js not found. Please enable Node.js in Plesk control panel first."
            exit 0
          fi

          # Verify Node.js version
          node --version
          npm --version

          # Install production dependencies
          echo "Installing dependencies..."
          npm install --production --no-audit --no-fund 2>/dev/null || {
            echo "âš ï¸ npm install had issues, trying npm ci..."
            npm ci --production --no-audit 2>/dev/null || {
              echo "âš ï¸ Dependencies installation failed, continuing anyway..."
            }
          }

          # Stop any existing Node.js processes on port 3000 (ignore errors)
          pkill -f "node.*3000" 2>/dev/null || echo "No processes to stop"
          sleep 1

          # Test the application
          echo "Testing Node.js application..."
          node -e "console.log('âœ… Node.js is working'); process.exit(0);" || {
            echo "âŒ Node.js test failed"
            exit 1
          }

          # Check if app.js exists and test syntax
          if [ -f "app.js" ]; then
            echo "âœ… app.js found"
            node -c app.js && echo "âœ… app.js syntax valid" || {
              echo "âŒ app.js syntax error"
              cat app.js
              exit 1
            }
          else
            echo "âŒ app.js not found"
            ls -la
            exit 1
          fi

          # Set proper file permissions
          chmod +x app.js
          chmod -R 755 apps/web/
          
          echo "ğŸš€ Application configured successfully"
          echo "ï¿½ Files deployed:"
          ls -la | head -10
          echo "ğŸ“ Web app files:"
          ls -la apps/web/ | head -5 2>/dev/null || echo "No apps/web directory"

    - name: âœ… Verify deployment
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: ${{ secrets.VPS_PORT || '22' }}
        script: |
          # Wait for app to start
          sleep 10

          # Test local endpoint
          curl -f -s http://localhost:3000 > /dev/null && echo "âœ… Local endpoint test passed" || echo "âš ï¸ Local endpoint test failed"

          # Test PDF API
          curl -f -s http://localhost:3000/api/resume/view > /dev/null && echo "âœ… PDF API test passed" || echo "âš ï¸ PDF API test failed"

          # Show recent logs
          pm2 logs portfolio-web --lines 10 || echo "No PM2 logs available"

    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸŒ Site: https://${{ secrets.DOMAIN_NAME }}"
        echo "ğŸ“‹ Check logs with: pm2 logs portfolio-web"
        echo "ğŸ“ˆ Monitor with: pm2 monit"