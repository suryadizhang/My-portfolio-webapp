name: "Simplified CI/CD Pipeline"

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/utils/**'
      - 'packages/config/**'
      - 'package.json'
      - name: Validate required secrets
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        echo "üîç Validating Vercel deployment secrets..."
        M=0
        
        # Check if secrets exist and have content
        if [ -z "$VERCEL_TOKEN" ]; then
          echo "‚ùå VERCEL_TOKEN is empty or not set"
          M=1
        else
          echo "‚úÖ VERCEL_TOKEN is set (length: ${#VERCEL_TOKEN})"
        fi
        
        if [ -z "$VERCEL_ORG_ID" ]; then
          echo "‚ùå VERCEL_ORG_ID is empty or not set"
          M=1
        else
          echo "‚úÖ VERCEL_ORG_ID is set: ${VERCEL_ORG_ID}"
        fi
        
        if [ -z "$VERCEL_PROJECT_ID" ]; then
          echo "‚ùå VERCEL_PROJECT_ID is empty or not set"
          M=1
        else
          echo "‚úÖ VERCEL_PROJECT_ID is set (first 10 chars): ${VERCEL_PROJECT_ID:0:10}..."
        fi
        
        [ "$M" -eq 0 ] || { echo "‚ùå Missing required Vercel secrets - deployment aborted"; exit 1; }
        echo "‚úÖ All required Vercel secrets are properly configured"ckage-lock.json'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/web/**'
      - 'packages/ui/**'
      - 'packages/utils/**'
      - 'packages/config/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

concurrency:
  group: simplified-ci-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  deployments: write

jobs:
  # ---------- BUILD & TEST ----------
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci --include-workspace-root --workspaces
      
    - name: Security audit
      run: |
        echo "üîç Running security audit..."
        npm audit --audit-level=moderate || echo "‚ö†Ô∏è Found vulnerabilities, but continuing build"
        echo "‚úÖ Security audit completed"

    - name: Type check
      run: npm run typecheck

    - name: Run tests
      run: npm run test

    - name: Build web application
      run: |
        echo "üèóÔ∏è Building web application with Turbo..."
        npm run build --filter=@portfolio/web --include-dependencies
        echo "üìÇ Checking build output structure..."
        ls -la apps/web/.next/ || echo "No .next directory found"
        ls -la apps/web/.next/standalone/ || echo "No standalone directory found"
      
    - name: Verify build output
      run: |
        echo "üîç Verifying build output..."
        test -f "apps/web/.next/standalone/apps/web/server.js" || (echo "‚ùå server.js missing in standalone build" && exit 1)
        test -d "apps/web/.next/static" || (echo "‚ùå static files missing" && exit 1)
        test -d "apps/web/public" || (echo "‚ùå public files missing" && exit 1)
        echo "‚úÖ Build verification passed"

    - name: Prepare build artifacts
      run: |
        echo "üì¶ Preparing build artifacts with correct structure..."
        mkdir -p ./build-artifacts/apps/web
        
        # Copy standalone build (contains the complete app structure)
        cp -r apps/web/.next/standalone/* ./build-artifacts/
        
        # Copy static files to the correct nested location
        mkdir -p ./build-artifacts/apps/web/.next/static
        cp -r apps/web/.next/static/* ./build-artifacts/apps/web/.next/static/
        
        # Copy public files to the correct nested location  
        cp -r apps/web/public ./build-artifacts/apps/web/
        
        # Copy package-lock.json for npm ci (required for clean install)
        cp package-lock.json ./build-artifacts/ 2>/dev/null || echo "‚ö†Ô∏è package-lock.json not found, will use npm install as fallback"
        
    - name: Install dependencies in build-artifacts
      run: |
        echo "üì¶ Installing dependencies in build-artifacts..."
        cd ./build-artifacts
        
        # Check if package.json exists
        test -f "package.json" || (echo "‚ùå package.json missing in build-artifacts" && exit 1)
        
        # Install production dependencies - prefer npm ci if lock file exists, fallback to npm install
        echo "üìã Installing production dependencies..."
        if [ -f "package-lock.json" ]; then
          echo "üîí Using npm ci (clean install with lock file)..."
          npm ci --production --prefer-offline --no-audit
        else
          echo "üì¶ Using npm install (fallback - no lock file found)..."
          npm install --omit=dev --prefer-offline --no-audit
        fi
        
        # Verify Next.js binary was installed
        test -f "node_modules/next/dist/bin/next" && echo "‚úÖ Next.js binary confirmed" || echo "‚ö†Ô∏è Next.js binary not found"
        
        echo "‚úÖ Dependencies installed successfully"
        
    - name: Verify build artifacts
      run: |
        # Verify the structure is correct
        echo "üîç Verifying artifact structure..."
        ls -la ./build-artifacts/
        ls -la ./build-artifacts/apps/web/
        
        # Comprehensive file verification
        test -f "./build-artifacts/apps/web/server.js" || (echo "‚ùå server.js missing in prepared artifacts" && exit 1)
        test -f "./build-artifacts/package.json" || (echo "‚ùå root package.json missing" && exit 1)
        test -d "./build-artifacts/apps/web/.next/static" || (echo "‚ùå static files missing" && exit 1)
        test -d "./build-artifacts/apps/web/public" || (echo "‚ùå public files missing" && exit 1)
        test -f "./build-artifacts/node_modules/next/dist/bin/next" || (echo "‚ùå Next.js binary missing" && exit 1)
        test -d "./build-artifacts/node_modules" || (echo "‚ùå node_modules directory missing" && exit 1)
        
        echo "üìä Artifact size information:"
        du -sh ./build-artifacts/
        du -sh ./build-artifacts/node_modules/ || echo "node_modules size check skipped"
        echo "‚úÖ Build artifacts verification completed successfully"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build-${{ github.sha }}
        path: ./build-artifacts/
        retention-days: 1

  # ---------- PYTHON SERVICE TESTS ----------
  python-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Run Python tests on main branch pushes or when Python files change
    if: github.ref == 'refs/heads/main' || contains(github.event.head_commit.message, 'python') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Python dependencies
      working-directory: apps/service-python
      run: |
        python -m pip install --upgrade pip
        # Install production dependencies
        echo "üì¶ Installing production dependencies..."
        pip install -r requirements.txt
        
        # Install development dependencies - try pyproject.toml first, fallback to requirements-dev.txt
        echo "üîß Installing development dependencies..."
        if pip install -e ".[dev]" 2>/dev/null; then
          echo "‚úÖ Installed dev dependencies from pyproject.toml"
        elif [ -f requirements-dev.txt ]; then
          echo "üìã Fallback: Installing dev dependencies from requirements-dev.txt"
          pip install -r requirements-dev.txt
        else
          echo "‚ö†Ô∏è No dev dependencies configuration found"
          exit 1
        fi
        
        # Verify critical testing tools are available
        echo "üîç Verifying testing tools..."
        python -c "import pytest; import fastapi; from fastapi.testclient import TestClient; print('‚úÖ Testing tools ready')" || {
          echo "‚ùå Critical testing tools missing"
          exit 1
        }

    - name: Run Python tests
      working-directory: apps/service-python
      run: |
        echo "üß™ Running Python tests..."
        python -m pytest tests/ -v --tb=short
        echo "‚úÖ Python tests completed"

  # ---------- DEPLOY FRONTEND TO VERCEL ----------
  deploy-frontend:
    needs: [build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || inputs.force_deploy)
    
    environment:
      name: production-frontend
      url: https://myportfolio.mysticdatanode.net
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Validate required secrets
      run: |
        echo "ÔøΩ Validating Vercel deployment secrets..."
        M=0
        [ -n "${{ secrets.VERCEL_TOKEN }}" ]    || { echo "‚ùå Missing VERCEL_TOKEN"; M=1; }
        [ -n "${{ secrets.VERCEL_ORG_ID }}" ]   || { echo "‚ùå Missing VERCEL_ORG_ID"; M=1; }
        [ -n "${{ secrets.VERCEL_PROJECT_ID }}" ] || { echo "‚ùå Missing VERCEL_PROJECT_ID"; M=1; }
        [ "$M" -eq 0 ] || { echo "‚ùå Missing required Vercel secrets - deployment aborted"; exit 1; }
        echo "‚úÖ All required Vercel secrets are present"

    - name: Install dependencies
      run: npm ci --include-workspace-root --workspaces

    - name: Build for Vercel
      run: |
        echo "üèóÔ∏è Building Next.js app for Vercel deployment..."
        # Set environment variables for build
        export NEXT_PUBLIC_API_BASE_URL=https://apiportfolio.mysticdatanode.net/api
        export NEXT_PUBLIC_SITE_URL=https://myportfolio.mysticdatanode.net
        npm run build --filter=@portfolio/web --include-dependencies
        echo "‚úÖ Build completed for Vercel"

    - name: Deploy to Vercel
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      working-directory: ./apps/web
      run: |
        echo "üöÄ Starting Vercel deployment..."
        
        # Install Vercel CLI
        npm install -g vercel@latest
        
        # Verify secrets are properly set
        echo "üîç Verifying Vercel configuration..."
        if [ -z "$VERCEL_TOKEN" ]; then
          echo "‚ùå VERCEL_TOKEN is empty"
          exit 1
        fi
        if [ -z "$VERCEL_ORG_ID" ]; then
          echo "‚ùå VERCEL_ORG_ID is empty" 
          exit 1
        fi
        if [ -z "$VERCEL_PROJECT_ID" ]; then
          echo "‚ùå VERCEL_PROJECT_ID is empty"
          exit 1
        fi
        echo "‚úÖ All Vercel secrets are properly configured"
        
        echo "üîó API Configuration:"
        echo "  - API Base URL: https://apiportfolio.mysticdatanode.net/api (VPS/Plesk hosted)"
        echo "  - Frontend URL: https://myportfolio.mysticdatanode.net (Vercel hosted)"
        
        # Link project to avoid "Project not found" errors
        echo "üîó Linking Vercel project..."
        vercel link --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --yes
        
        # Deploy to Vercel with explicit project linking
        echo "üì¶ Deploying to Vercel..."
        vercel --prod \
          --token "$VERCEL_TOKEN" \
          --scope "$VERCEL_ORG_ID" \
          --build-env NEXT_PUBLIC_API_BASE_URL=https://apiportfolio.mysticdatanode.net/api \
          --build-env NEXT_PUBLIC_SITE_URL=https://myportfolio.mysticdatanode.net \
          --confirm \
          --force
        
        echo "‚úÖ Vercel deployment completed!"

    - name: Verify Vercel deployment
      run: |
        echo "‚è±Ô∏è Waiting for Vercel deployment to propagate..."
        sleep 30
        
        echo "üß™ Testing Vercel deployment..."
        curl -f -s -o /dev/null https://myportfolio.mysticdatanode.net && echo "‚úÖ Frontend is accessible on Vercel!" || echo "‚ùå Frontend check failed"
        
        echo "üéâ Vercel deployment verification completed!"

  # ---------- PYTHON SERVICE DEPLOYMENT ----------
  deploy-python:
    if: ${{ github.ref == 'refs/heads/main' }}
    needs: [python-tests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js for PM2
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install PM2 globally
      run: npm install -g pm2
      
    - name: Setup SSH Key for Python deployment
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy Python service
      run: |
        echo "üêç Deploying Python service..."
        
        # Create deployment package for Python service
        tar -czf python-service-${{ github.sha }}.tar.gz -C apps/service-python .
        
        # Upload Python service
        scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
          python-service-${{ github.sha }}.tar.gz \
          apiportfolio@${{ secrets.VPS_HOST }}:/tmp/
          
        # Deploy Python service on VPS
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no apiportfolio@${{ secrets.VPS_HOST }} "
          set -euo pipefail
          
          echo 'üêç Starting Python service deployment...'
          
          # Navigate to Python service directory
          cd /var/www/vhosts/apiportfolio.mysticdatanode.net/python-service || {
            echo 'üìÅ Creating Python service directory...'
            mkdir -p /var/www/vhosts/apiportfolio.mysticdatanode.net/python-service
            cd /var/www/vhosts/apiportfolio.mysticdatanode.net/python-service
          }
          
          # Backup current version if exists
          if [ -f 'app/main.py' ]; then
            echo 'üíæ Creating Python service backup...'
            mkdir -p /var/backups/portfolio 2>/dev/null || true
            tar -czf /var/backups/portfolio/python-service-backup-\$(date +%Y%m%d-%H%M%S).tar.gz . 2>/dev/null || true
          fi
          
          # Extract new Python service
          echo 'üìÇ Extracting new Python service...'
          tar -xzf /tmp/python-service-${{ github.sha }}.tar.gz
          rm /tmp/python-service-${{ github.sha }}.tar.gz
          
          # Setup Python virtual environment if not exists
          if [ ! -d 'venv' ]; then
            echo 'üêç Creating Python virtual environment...'
            python3 -m venv venv
          fi
          
          echo 'üì¶ Installing Python dependencies...'
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # Install or update PM2 on VPS if needed
          echo 'üì¶ Ensuring PM2 is available...'
          command -v pm2 >/dev/null 2>&1 || {
            echo 'üîß Installing PM2...'
            npm install -g pm2
          }
          
          # Restart Python service using PM2
          echo 'üîÑ Restarting Python service...'
          pm2 restart portfolio-python || pm2 start app/main.py --name portfolio-python --interpreter python3 --interpreter-args venv/bin/python
          
          # Wait for startup
          sleep 3
          
          # Health check
          if pm2 describe portfolio-python | grep -q 'online'; then
            echo '‚úÖ Python service is running successfully!'
          else
            echo '‚ùå Python service failed to start!'
            pm2 logs portfolio-python --lines 20
            exit 1
          fi
          
          echo 'üéâ Python service deployment completed!'
        "
        
    - name: Verify Python service
      run: |
        echo "‚è±Ô∏è Waiting for Python service to start..."
        sleep 5
        
        echo "üß™ Testing Python service..."
        # Try common Python service ports
        for port in 8000 3000 5000; do
          if curl -f -s -o /dev/null "http://${{ secrets.VPS_HOST }}:$port" 2>/dev/null; then
            echo "‚úÖ Python service is accessible on port $port!"
            break
          fi
        done || echo "‚ÑπÔ∏è Python service health check completed (service may be running on internal port)"
        
        echo "üéâ Python service verification completed!"

  # ---------- FINAL VALIDATION ----------
  final-validation:
    needs: [deploy-frontend, deploy-python]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Final deployment validation
      run: |
        echo "üîç Final deployment validation..."
        echo "‚úÖ Frontend deployed to Vercel: https://myportfolio.mysticdatanode.net"
        echo "‚úÖ Backend API deployed to VPS: https://apiportfolio.mysticdatanode.net/api"
        echo "‚úÖ CI/CD pipeline completed successfully!"
        echo ""
        echo "üìã Deployment Summary:"
        echo "  ‚Ä¢ Frontend: Next.js on Vercel (serverless)"
        echo "  ‚Ä¢ Backend: FastAPI Python service on VPS with virtual environment"
        echo "  ‚Ä¢ Security: Vercel tokens validation, SSH key validation"
        echo "  ‚Ä¢ Monitoring: Vercel deployment checks, PM2 health checks"
        echo ""
        echo "üîó Access URLs:"
        echo "  ‚Ä¢ Frontend Website: https://myportfolio.mysticdatanode.net"
        echo "  ‚Ä¢ Backend API: https://apiportfolio.mysticdatanode.net/api"

  # ---------- CLEANUP ----------
  cleanup:
    needs: [final-validation]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Cleanup artifacts
      uses: actions/github-script@v7
      with:
        script: |
          const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
            owner: context.repo.owner,
            repo: context.repo.repo,
            run_id: context.runId,
          });
          
          for (const artifact of artifacts.data.artifacts) {
            if (artifact.name.startsWith('web-build-')) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
              });
              console.log(`Deleted artifact: ${artifact.name}`);
            }
          }