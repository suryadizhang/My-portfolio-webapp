name: "Portfolio CI/CD - Backend Only"

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/service-python/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/service-python/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force backend deployment'
        required: false
        default: false
        type: boolean

concurrency:
  group: backend-ci-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  deployments: write

jobs:
  test-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd apps/service-python
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Python tests
      run: |
        cd apps/service-python
        python -m pytest || echo "No tests found, skipping..."
        
    - name: Type check
      run: |
        cd apps/service-python
        python -m mypy . || echo "Type checking skipped"

  deploy-backend:
    needs: [test-backend]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || inputs.force_deploy)
    
    environment:
      name: production
      url: https://apiportfolio.mysticdatanode.net
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
        
        # Configure SSH to prevent hanging
        cat >> ~/.ssh/config << EOF
        Host ${{ secrets.VPS_HOST }}
          ServerAliveInterval 30
          ServerAliveCountMax 3
          ConnectTimeout 10
        EOF
        
    - name: Deploy Python service to VPS
      run: |
        echo "ğŸš€ Deploying Python service to VPS..."
        
        tar -czf python-service.tar.gz -C apps/service-python .
        timeout 60 scp -i ~/.ssh/id_rsa -o ConnectTimeout=10 python-service.tar.gz apiportfolio@${{ secrets.VPS_HOST }}:/tmp/
          
        timeout 300 ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 apiportfolio@${{ secrets.VPS_HOST }} bash << 'ENDSSH'
          set -e
          echo "ğŸ”§ Starting Python deployment..."
          mkdir -p ~/python-service && cd ~/python-service
          
          if [ -d "app" ]; then tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz app/ || true; fi
          
          tar -xzf /tmp/python-service.tar.gz && rm /tmp/python-service.tar.gz
          
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" > .env
          echo "ALLOWED_ORIGINS=https://myportfolio.mysticdatanode.net,https://my-portfolio-webapp-web.vercel.app" >> .env
          echo "NODE_ENV=production" >> .env
          echo "LOG_LEVEL=info" >> .env
          
          [ ! -d "venv" ] && python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet
          
          pkill -f "uvicorn app.main:app" || true
          sleep 2
          
          python3 -c "from app.main import app; print('âœ… App validated')"
          
          nohup python3 -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > app.log 2>&1 &
          sleep 5
          
          if pgrep -f "uvicorn app.main:app" > /dev/null; then
            echo "âœ… Service started!"
            curl -f http://localhost:8000/health || echo "âš ï¸ Health check warning"
          else
            echo "âŒ Service failed to start"
            tail -50 app.log
            exit 1
          fi
        ENDSSH
        
        echo "âœ… Deployment completed!"

  validate-deployment:
    needs: [deploy-backend]
    runs-on: ubuntu-latest
    if: always() && needs.deploy-backend.result == 'success'
    
    steps:
    - name: Health Check
      run: |
        echo "ğŸ” Validating backend deployment..."
        sleep 10  # Give service time to fully start
        
        # Health check with retry
        for i in {1..5}; do
          if curl -f --max-time 30 https://apiportfolio.mysticdatanode.net/health; then
            echo "âœ… Backend health check passed!"
            break
          else
            echo "âš ï¸ Health check attempt $i failed, retrying..."
            sleep 10
          fi
        done
        
    - name: Deployment Summary
      run: |
        echo "ğŸ“‹ Deployment Summary:"
        echo "âœ… Backend API: https://apiportfolio.mysticdatanode.net"
        echo "â„¹ï¸  Frontend: Auto-deployed by Vercel on push"
        echo "ğŸ‰ Backend deployment pipeline completed!"